.MODEL SMALL
.STACK  64
.DATA     
   ;PORT ADDRESSES 8255
   PORTA EQU 1000H ;PORTA 8255 D7-D0
   PORTB EQU 1002H ;PORTA 8255 D7-D0
   PORTC EQU 1004H ;PORTA 8255 D7-D0
   PCW   EQU 1006H	;CTRL WORD
   
   ;8259
   PIC1 EQU 0000H
   PIC2 EQU 0002H
   ;8251 PORT
   USART0 	EQU 2000H
   USART1 	EQU 2002H
   TEMP DB 	00H,00H,00H
   .CODE
   MAIN PROC FAR
    ; SET SEGMENT REGISTERS:
    MOV AX, @DATA
    MOV DS, AX
    MOV ES, AX
    CLI
   ;USART INIT    
	
   ;WRITE GARBAGE SYNC CHAR THEN RST AND INIT
   MOV DX, USART1
   MOV AL, 00H		; SEND GARBAGE
   OUT DX, AL
	    
   MOV DX, USART1
   MOV AL, 00H		; SEND GARBAGE
   OUT DX, AL
	
   MOV DX, USART1
   MOV AL, 00H		; SEND GARBAGE
   OUT DX, AL
	
   MOV DX, USART1
   MOV AL, 40H		; RST CMD
   OUT DX, AL          
	          
   MOV DX, USART1
   MOV AL, 4DH		; SEND MODE
   OUT DX, AL
	
   MOV DX, USART1
   MOV AL, 15H		;SEND CTRL WORD
   OUT DX, AL

   ;8259A INITIALIZATION
    MOV AL, 17H
    MOV DX, PIC1
    OUT DX, AL  ;WRITE ICW1
		
    MOV DX, PIC2
    MOV AL, 080H
    OUT DX, AL  ;WRITE ICW2
    MOV AL, 01H
    OUT DX, AL  ;WRITE ICW4  
    
   ;8255 INIT
    MOV DX,PCW
    MOV AL,80H ;8255 CTRL WORD
    OUT DX,AL 

   ;ISR SETUP
   
   ;	READ CHAR_PRESENT ISR
	 XOR AX,AX              
		MOV ES,AX
		MOV AL,80H
		MOV AH,4
		MUL AH
		MOV BX,AX
		MOV AX,OFFSET CHAR_PRESENT
		MOV WORD PTR ES:[BX],AX
		INC BX
		INC BX
		MOV AX,SEG CHAR_PRESENT
		MOV WORD PTR ES:[BX],AX

		 ;ADC ISR
	 XOR AX,AX              
		MOV ES,AX
		MOV AL,81H
		MOV AH,4
		MUL AH
		MOV BX,AX
		MOV AX,OFFSET ADC_ISR
		MOV WORD PTR ES:[BX],AX
		INC BX
		INC BX
		MOV AX,SEG ADC_ISR
		MOV WORD PTR ES:[BX],AX

		;FALBACK ISR
		XOR AX,AX  
		MOV ES,AX
		MOV AL,87H
		MOV AH,4
		MUL AH
		MOV BX,AX
		MOV AX,OFFSET DEFAULT
		MOV WORD PTR ES:[BX],AX
		INC BX
		INC BX
		MOV AX, SEG DEFAULT
		MOV WORD PTR ES:[BX],AX

		MOV AL, 00H
		MOV DX,PORTA
		OUT DX,AL
		STI
		ENDLESS:
			XOR AX,AX
			JMP ENDLESS

	;INTERRUT ROUTINES
	DEFAULT PROC FAR
		IRET
	DEFAULT ENDP
	
	
	ADC_ISR PROC FAR
		PUSH AX
		PUSH BX
		PUSH CX
		PUSH DX
		PUSH BP
		PUSH SI
		PUSH DI
		STI
		CLI
		;IMPLEMENTATION
		
		MOV DX, USART1
		IN AL, DX
		
		MOV DX,PORTB
		IN  AL,DX
		
		MOV DX, USART0
		OUT DX, AL
		
		;SEND SPECIFIC EOI
		MOV AL, 061H
		MOV DX, PIC1
		OUT DX, AL

		POP BP
		POP SI
		POP DI
		POP DX
		POP CX
		POP BX
		POP AX
		IRET
	ADC_ISR ENDP
	
	 CHAR_PRESENT PROC FAR
		PUSH AX
		PUSH BX
		PUSH CX
		PUSH DX
		PUSH BP
		PUSH SI
		PUSH DI
		STI
		CLI
		;IMPLEMENTATION
		MOV DX,USART0
		IN  AL,DX
		SHR AL,1
		
		XOR AH,AH
		MOV BL,10
		DIV BL
	        MOV BX,02H
	        MOV TEMP[BX],AH

		 XOR AH,AH
		 MOV BL,10
		 DIV BL
		 MOV BX,01H
		 MOV TEMP[BX],AH
	
		 XOR AH,AH
		 MOV BL,10
		 DIV BL
		 MOV BX,00H
		 MOV TEMP[BX],AH
		
		 XOR AX,AX
		 XOR CX,CX
		 XOR BX,BX
		 MOV BX,00H
		 MOV CL,4
		 MOV AL,TEMP[BX]
		 SHL AL,CL  
		 
		 MOV BX,01H
		 OR  AL,TEMP[BX]
		 MOV DX, PORTA
		 OUT DX,AL
				
		XOR AX,AX
		MOV BX,02H
		MOV AL,TEMP[BX]
		
		MOV DX, PORTC
		OUT DX,AL
		
		;SEND SPECIFIC EOI
		MOV AL, 060H
		MOV DX, PIC1
		OUT DX, AL

		POP BP
		POP SI
		POP DI
		POP DX
		POP CX
		POP BX
		POP AX
		IRET
	CHAR_PRESENT ENDP
MAIN ENDP
END MAIN